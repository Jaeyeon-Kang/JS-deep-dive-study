## 실행 컨텍스트

실행 컨텍스트는 JavaScript가 동작하는 방식의 핵심 개념이다. 실행 컨텍스트를 이해하면, JavaScript가 스코프를 기반으로 식별자와 값(변수)을 어떻게 관리하는지, 호이스팅이 왜 발생하는지, 클로저가 어떻게 동작하는지, 그리고 이벤트 핸들러와 비동기 처리(Task Queue)의 동작 방식을 이해할 수 있다.

### 소스 코드의 타입

JavaScript의 소스 코드는 4가지 종류로 나뉜다.

1. 전역 코드
2. 함수 코드
3. Eval 코드
4. 모듈 코드

### 소스코드의 평가와 실행

- 자바스크립트 엔진은 소스코드를 소스코드의 평가와 소스코드의 실행 과정으로 나누어 처리한다.

1. 소스 코드 평가 과정

- 실행 컨텍스트가 생성된다.
- 변수 선언문과 함수 선언문이 먼저 실행된다.
- 선언된 변수와 함수는 실행 컨텍스트의 스코프에 등록된다.
- 이 과정에서 변수는 초기화되지 않고(undefined 할당), 함수 선언문은 메모리에 등록된다.

2. 소스 코드 실행 과정

- 평가가 끝난 후, 실제 실행이 이루어진다.
- 변수에 값이 할당될 때, 실행 컨텍스트의 스코프에서 해당 변수를 검색하여 값을 변경한다.
- 실행 결과는 실행 컨텍스트가 관리하는 스코프에 저장된다.

  ```
  var x;
  x = 1;
  ```

- 1단계: 소스 코드 평가
  var x; → 변수 x가 실행 컨텍스트의 스코프에 등록된다. (값은 undefined)
  2단계: 소스 코드 실행
- x = 1; → 실행 컨텍스트에서 x가 존재하는지 확인한 후, 1을 할당한다.

### 실행 컨텍스트의 역할

- 코드 실행 과정에서 실행 컨텍스트는 다음과 같은 역할을 수행한다.

1.  식별자, 변수, 함수, 클래스 등의 선언을 스코프를 구분하여 등록하고 상태 변화를 관리한다.
2.  스코프 체인을 형성하여 상위 스코프로 이동하며 식별자를 검색할 수 있도록 한다.
3.  함수 호출 시 실행 순서를 변경하고, 종료 후 다시 되돌아갈 수 있도록 실행 순서를 관리한다.

- 실행 컨텍스트는 코드 실행을 위한 환경을 제공하며, 식별자와 코드 실행 순서를 관리하는 내부 메커니즘으로 작동한다.

### 실행 컨텍스트 스택

- 실행 컨텍스트 스택은 코드의 실행 순서를 관리하며, 실행 중인 코드에 따라 실행 컨텍스트를 추가하거나 제거하는 역할을 한다.

  ```
  const x = 1;
  function foo () {
      const y=2;
      function bar(){
          const z = 3;
          console.log(x+y+z);
      }
      bar()
  }

  foo()
  ```

1. 전역 코드 평가
   자바스크립트 엔진은 먼저 전역 코드를 평가하여 전역 실행 컨텍스트(Global Execution Context)를 생성하고 실행 컨텍스트 스택에 푸시(Push) 한다.
   이 과정에서 전역 변수와 전역 함수가 전역 실행 컨텍스트에 등록된다. - const x = 1; → 전역 스코프에 등록됨 - function foo() { ... } → 전역 스코프에 등록됨

2. 전역 코드 실행
   전역 코드 평가 후 런타임이 시작되며, 전역 코드가 순차적으로 실행된다.

   - const x = 1; → 전역 변수 값이 할당됨
   - foo(); → 함수 호출 발생
   - 함수 호출 시, 실행 중이던 전역 코드의 실행이 일시 중단되고 코드 실행 순서가 foo 함수 내부로 변경됨.
   - 이때 foo 함수 실행 컨텍스트가 생성되고 실행 컨텍스트 스택에 푸시됨.

3. foo 함수 코드 평가
   foo 함수가 실행되기 전에 foo 함수 실행 컨텍스트가 생성되며, 실행 컨텍스트 스택에 추가된다.

   - const y = 2; → foo 함수의 지역 스코프에 등록됨
   - function bar() { ... } → foo 함수의 지역 스코프에 등록
   - const y = 2; → 지역 변수 값이 할당됨
   - bar(); → bar 함수 호출
   - 실행 중이던 foo 함수의 실행이 일시 중단되고 코드 실행 순서가 bar 함수 내부로 변경됨.
   - 이때 bar 함수 실행 컨텍스트가 생성되고 실행 컨텍스트 스택에 푸시됨.

4. bar 함수 코드 평가

   - bar 함수 실행 전에 bar 함수 실행 컨텍스트가 생성되며 실행 컨텍스트 스택에 추가된다.
   - const z = 3; → bar 함수의 지역 스코프에 등록됨
   - const z = 3; → 지역 변수 값이 할당됨
   - console.log(x + y + z); 실행

5. foo 함수 코드로 복귀
   bar 함수 실행이 종료되면 코드 실행 순서가 foo 함수로 돌아간다.

6. 전역 코드로 복귀
   foo 함수가 종료되면 코드 실행 순서가 전역 코드로 돌아간다.

### 렉시컬 환경

- 렉시컬 환경은 키와 값을 갖는 객체 형태의 스코프(전역, 함수, 블록 스코프)를 생성하여, 식별자를 키로 등록하고 식별자에 바인딩된 값을 관리한다.
- 즉, 렉시컬 환경은 스코프를 구분하여 식별자를 등록하고 관리하는 저장소 역할을 수행하는 렉시컬 스코프의 실체이다.
- 렉시컬 환경의 구성 요소

1. 환경 레코드(Environment Record)
   - 현재 실행 컨텍스트에서 선언된 식별자(변수, 함수, 클래스 등)를 등록하고 바인딩된 값을 저장하는 역할을 한다.
   - 소스 코드의 타입(전역 코드, 함수 코드 등)에 따라 관리하는 내용이 달라진다.
2. 외부 렉시컬 환경에 대한 참조(Outer Lexical Environment Reference)
   - 상위 스코프를 가리키는 참조이다.
   - 즉, 현재 실행 컨텍스트를 생성한 외부 렉시컬 환경을 참조하여 스코프 체인을 구성한다.
   - 단방향 링크드 리스트 형태로 상위 스코프를 참조하며, 이를 통해 스코프 체인이 구현된다.

### 실행 컨텍스트의 생성과 식별자 검색 과정
  ```
  var x=1;
  const y = 2;

  function foo (a) {
      var x=3;
      const y=4;

      function bar(b){
          const z = 5;
          console.log(a+b+x+y+z);
      }
      bar(10)
  }

  foo(20) // 42
  ```
#### 전역 객체 생성

- **전역 객체(Global Object)**는 전역 코드가 평가되기 이전에 생성된다.

  - 전역 객체에는 빌트인 전역 프로퍼티, 빌트인 전역 함수, 그리고 표준 빌트인 객체가 추가된다.
  - 동작 환경(클라이언트 사이드 또는 서버 사이드)에 따라 호스트 객체(예: DOM, BOM, Canvas, XML, HTTP request, Fetch 등)가 포함될 수도 있다.
  - 전역 객체도 Object.prototype을 상속받으며, 프로토타입 체인의 일원이다.

#### 전역 코드 평가

소스 코드가 로드되면 JavaScript 엔진은 전역 코드를 평가하며, 전역 코드 평가는 다음과 같은 순서로 진행된다.

1. 전역 실행 컨텍스트 생성
2. 전역 렉시컬 환경 생성  
   2.1. 전역 환경 레코드 생성  
    2.1.1 객체 환경 레코드 생성  
    2.1.2 선언적 환경 레코드 생성  
   2.2 this 바인딩  
   2.3 외부 렉시컬 환경에 대한 참조 결정

이 과정을 거쳐 전역 실행 컨텍스트와 렉시컬 환경이 생성된다.

1. 전역 실행 컨텍스트 생성
    - 비어 있는 전역 실행 컨텍스트를 생성하고, 이를 실행 컨텍스트 스택에 푸시(Push) 한다.
    - 이때 전역 실행 컨텍스트는 실행 컨텍스트 스택의 최상위(즉, 실행 중인 실행 컨텍스트)가 된다.

2. 전역 렉시컬 환경 생성
    - 전역 렉시컬 환경(Global Lexical Environment)을 생성하고, 이를 전역 실행 컨텍스트에 바인딩한다.
    - 렉시컬 환경은 두 개의 컴포넌트로 구성된다.
        - 환경 레코드(Environment Record)
    - 외부 렉시컬 환경에 대한 참조(Outer Lexical Environment Reference)

    2.1 전역 환경 레코드 생성
    - 전역 환경 레코드(Global Environment Record)는 전역 변수를 관리하는 전역 스코프 역할을 한다.
    - 전역 객체의 빌트인 전역 프로퍼티, 빌트인 전역 함수, 표준 빌트인 객체를 제공한다.
    - 전역 환경 레코드는 객체 환경 레코드와 선언적 환경 레코드로 구성된다.

        2.1.1 객체 환경 레코드 생성
        - var 키워드로 선언한 전역 변수, 함수 선언문으로 정의한 전역 함수가 객체 환경 레코드에 연결된 BindingObject를 통해 전역 객체의 프로퍼티와 메소드가 된다.

        2.1.2 선언적 환경 레코드 생성

        - var 키워드로 선언한 전역 변수와 함수 선언문 외의 선언(예: let, const)은 선언적 환경 레코드(Declarative Environment Record)에 등록된다.
        - let, const로 선언한 전역 변수는 전역 객체의 프로퍼티가 되지 않고, 개념적인 블록 내에서 관리된다.
        - TDZ(일시적 사각지대)로 인해 let, const 변수는 선언 전에 접근할 수 없다.

    2.2 this 바인딩
    - 전역 환경 레코드의 Global This Value 내부 슬롯에는 this가 바인딩(Binding)된다.
    - 전역 환경 레코드의 Global This Value 내부 슬롯에는 전역 객체가 바인딩된다.즉, 전역 코드에서 this를 참조하면 전역 환경 레코드의 Global This Value 내부 슬롯에 바인딩된 객체가 반환된다.
    - 전역 환경 레코드를 구성하는 객체 환경 레코드와 선언적 환경 레코드에는 this 바인딩이 존재하지 않고 전역 환경 레코드와 함수 환경 레코드에만 존재한다.

    2.3 외부 렉시컬 환경에 대한 참조 결정
    - 외부 렉시컬 환경에 대한 참조(Outer Lexical Environment Reference)는 현재 평가 중인 소스 코드를 포함하는 외부 소스 코드의 렉시컬 환경, 즉 상위 스코프를 가리킨다.
    - 이를 통해 단방향 링크드 리스트 형태의 스코프 체인을 구현한다.
    - 전역 코드를 포함하는 외부 소스 코드는 존재하지 않으므로, 전역 렉시컬 환경의 외부 렉시컬 환경에 대한 참조에는 null이 할당된다.
 
 #### 전역 코드 실행
 - 위 과정이 끝나면 전역 코드가 순차적으로 실행되기 시작한다.
 - 변수 할당문 또는 함수 호출문을 실행하려면 먼저 변수 또는 함수 이름이 선언된 식별자인지 확인해야 한다. 식별자는 스코프가 다르면 같은 이름을 가질 수 있으며, 동일한 이름의 식별자가 여러 개 존재할 수도 있다. 따라서 어느 스코프에서 식별자를 참조해야 하는지 결정할 필요가 있는데 이를 `식별자 결정`이라고 한다.

 #### foo 함수 코드 평가
  ```
  var x=1;
  const y = 2;

  function foo (a) {
      var x=3;
      const y=4;

      function bar(b){
          const z = 5;
          console.log(a+b+x+y+z);
      }
      bar(10)
  }

  foo(20) // <- 호출 직전
  ```
- 예제 코드를 다시 살펴보면, 현재는 전역 코드 평가를 통해 전역 실행 컨텍스트가 생성되었으며, 전역 코드가 실행 중인 상태이다.
현재 진행 상황은 foo 함수를 호출하기 직전이다.
- 함수 코드 평가는 아래와 같은 순서로 진행된다.
1. 함수 실행 컨텍스트 생성
- foo 함수가 호출되면 전역 코드 실행이 일시 중단되고, 제어권이 foo 함수 내부로 이동한다.
- 자바스크립트 엔진은 foo 함수 코드 평가를 시작하며, 실행 컨텍스트를 생성한다.
- 생성된 foo 함수 실행 컨텍스트는 실행 컨텍스트 스택의 최상위에 위치하며, 현재 실행 중인 컨텍스트가 된다.
2. 함수 렉시컬 환경 생성
- foo 함수의 렉시컬 환경(Function Lexical Environment)을 생성하고, 이를 foo 함수 실행 컨텍스트에 바인딩한다.
- 렉시컬 환경에서는 다음과 같은 일이 일어난다.  

   2.1 함수 환경 레코드 생성
   - 함수 환경 레코드는 매개변수, arguments 객체, 함수 내부에서 선언한 지역 변수와 중첩 함수를 등록하고 관리한다.  

   2.2 this 바인딩
   - 함수 환경 레코드의 [[ThisValue]] 내부 슬롯에 this가 비인딩된다. foo 함수는 일반 함수로 호출되었으므로 this는 전역 객체를 가리킨다.  

   2.3 외부 렉시컬 환경에 대한 참조 결정
   - 외부 렉시컬 환경에 대한 참조에 foo 함수 정의가 평가된 시점에 실행 중인 실행 컨텍스트의 렉시컬 환경의 참조가 할당된다. foo .함수는 전역 함수이기 때문에 외부 렉시컬 환경에 대한 참조에는 전역 렉시컬 환경의 참조가 할당된다.

#### bar 함수 코드 평가
- 현재 진행 상황은 bar 함수를 호출하기 직전이다.
- bar 함수가 호출되면 foo 함수 코드 실행이 일시 중단되고, 제어권이 bar 함수 내부로 이동한다.
- 자바스크립트 엔진은 bar 함수 코드 평가를 시작하며, 실행 컨텍스트를 생성한다.
- 생성된 bar 실행 컨텍스트는 실행 컨텍스트 스택의 최상위에 위치하며, 현재 실행 중인 컨텍스트가 된다.
- 이 과정은 foo 함수 코드 평가 과정과 동일하다.

#### bar 함수 코드 실행
이제 런타임이 시작되며 bar 함수의 소스 코드가 순차적으로 실행된다.

- 매개변수 b에 전달된 인수 10이 할당된다.
- 변수 z에 값 5가 할당된다.
- console.log(a + b + x + y + z) 실행
- 각 스코프 체인을 통해 검색하여 식별자 결정을 한 뒤 표현식을 평가하여 결과적으로 42를 호출한다.

#### bar 함수 코드 실행 종료
- 더 이상 실행할 코드가 없으므로, bar 함수 실행 컨텍스트가 실행 컨텍스트 스택에서 팝(pop)된다.
- 이제 foo 함수 실행 컨텍스트가 다시 최상위가 된다.

#### foo 함수 코드 실행 종료
- 더 이상 실행할 코드가 없으므로, foo 함수 실행 컨텍스트가 실행 컨텍스트 스택에서 팝(pop)된다.
- 전역 실행 컨텍스트가 다시 최상위가 된다.

#### 전역 코드 실행 종료
- foo 함수가 종료되면 더는 실행할 전역 코드가 없으므로 전역 코드 실행이 종료된다.
- 전역 실행 컨텍스트가 실행 컨텍스트 스택에서 팝(pop)되며, 실행 컨텍스트 스택에는 아무것도 남지 않게 된다.

### 실행 컨텍스트와 블록 레벨 스코프
- 블록 스코프를 생성하는 블록문(if, for, while, try/catch 등)이 실행될 때 새로운 렉시컬 환경이 생성된다.